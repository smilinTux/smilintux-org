name: Monorepo CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      capauth: ${{ steps.filter.outputs.capauth }}
      skcomm: ${{ steps.filter.outputs.skcomm }}
      skchat: ${{ steps.filter.outputs.skchat }}
      skmemory: ${{ steps.filter.outputs.skmemory }}
      sksecurity: ${{ steps.filter.outputs.sksecurity }}
      cloud9: ${{ steps.filter.outputs.cloud9 }}
      skpdf: ${{ steps.filter.outputs.skpdf }}
      skcapstone: ${{ steps.filter.outputs.skcapstone }}
      skseal: ${{ steps.filter.outputs.skseal }}
      skref: ${{ steps.filter.outputs.skref }}
      skyforge: ${{ steps.filter.outputs.skyforge }}
      skskills: ${{ steps.filter.outputs.skskills }}
      sksovereign-agent: ${{ steps.filter.outputs.sksovereign-agent }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            capauth:
              - 'capauth/**'
            skcomm:
              - 'skcomm/**'
            skchat:
              - 'skchat/**'
            skmemory:
              - 'skmemory/**'
            sksecurity:
              - 'sksecurity/**'
            cloud9:
              - 'cloud9-python/**'
            skpdf:
              - 'skpdf/**'
            skcapstone:
              - 'skcapstone/**'
            skseal:
              - 'skseal/**'
            skref:
              - 'skref/**'
            skyforge:
              - 'skyforge/**'
            skskills:
              - 'skskills/**'
            sksovereign-agent:
              - 'sksovereign-agent/**'

  # ── Core packages (full matrix + linting) ────────────────────

  capauth:
    needs: detect-changes
    if: needs.detect-changes.outputs.capauth == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    defaults:
      run:
        working-directory: capauth
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - run: pip install -e ".[dev]"
      - run: python -m pytest tests/ -v --tb=short --cov=capauth --cov-report=xml:coverage.xml
      - run: black --check src/ tests/
        if: matrix.python-version == '3.12'
      - uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.12'
        with:
          name: coverage-capauth
          path: capauth/coverage.xml

  skcomm:
    needs: detect-changes
    if: needs.detect-changes.outputs.skcomm == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    defaults:
      run:
        working-directory: skcomm
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - run: pip install -e ".[all,dev]" || pip install -e ".[dev]"
      - run: python -m pytest tests/ -v --tb=short --cov=skcomm --cov-report=xml:coverage.xml
      - run: black --check src/ tests/
        if: matrix.python-version == '3.12'
      - uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.12'
        with:
          name: coverage-skcomm
          path: skcomm/coverage.xml

  skchat:
    needs: detect-changes
    if: needs.detect-changes.outputs.skchat == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    defaults:
      run:
        working-directory: skchat
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - run: pip install -e ".[cli,dev]"
      - run: pip install -e ../skmemory || true
      - run: python -m pytest tests/ -v --tb=short --cov=skchat --cov-report=xml:coverage.xml
      - run: black --check src/ tests/
        if: matrix.python-version == '3.12'
      - uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.12'
        with:
          name: coverage-skchat
          path: skchat/coverage.xml

  skmemory:
    needs: detect-changes
    if: needs.detect-changes.outputs.skmemory == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    defaults:
      run:
        working-directory: skmemory
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - run: pip install -e ".[dev]"
      - run: python -m pytest tests/ -v --tb=short --cov=skmemory --cov-report=xml:coverage.xml
      - run: black --check skmemory/ tests/
        if: matrix.python-version == '3.12'
      - uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.12'
        with:
          name: coverage-skmemory
          path: skmemory/coverage.xml

  sksecurity:
    needs: detect-changes
    if: needs.detect-changes.outputs.sksecurity == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    defaults:
      run:
        working-directory: sksecurity
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - run: pip install -e ".[dev]"
      - run: python -m pytest tests/ -v --tb=short --cov=sksecurity --cov-report=xml:coverage.xml
      - uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.12'
        with:
          name: coverage-sksecurity
          path: sksecurity/coverage.xml

  cloud9:
    needs: detect-changes
    if: needs.detect-changes.outputs.cloud9 == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    defaults:
      run:
        working-directory: cloud9-python
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - run: pip install -e ".[dev]"
      - run: python -m pytest tests/ -v --tb=short --cov=cloud9 --cov-report=xml:coverage.xml
      - uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.12'
        with:
          name: coverage-cloud9
          path: cloud9-python/coverage.xml

  skpdf:
    needs: detect-changes
    if: needs.detect-changes.outputs.skpdf == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    defaults:
      run:
        working-directory: skpdf
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - run: pip install -e ".[dev]"
      - run: python -m pytest tests/ -v --tb=short --cov=skpdf --cov-report=xml:coverage.xml
      - uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.12'
        with:
          name: coverage-skpdf
          path: skpdf/coverage.xml

  skcapstone:
    needs: detect-changes
    if: needs.detect-changes.outputs.skcapstone == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    defaults:
      run:
        working-directory: skcapstone
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - run: pip install -e ".[dev]"
      - run: python -m pytest tests/ -v --tb=short --cov=skcapstone --cov-report=xml:coverage.xml
      - uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.12'
        with:
          name: coverage-skcapstone
          path: skcapstone/coverage.xml

  # ── Additional packages ──────────────────────────────────────

  skseal:
    needs: detect-changes
    if: needs.detect-changes.outputs.skseal == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    defaults:
      run:
        working-directory: skseal
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - run: pip install -e ".[dev]"
      - run: python -m pytest tests/ -v --tb=short --cov=skseal --cov-report=xml:coverage.xml
      - uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.12'
        with:
          name: coverage-skseal
          path: skseal/coverage.xml

  skref:
    needs: detect-changes
    if: needs.detect-changes.outputs.skref == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    defaults:
      run:
        working-directory: skref
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - run: pip install -e ".[dev]"
      - run: python -m pytest tests/ -v --tb=short --cov=skref --cov-report=xml:coverage.xml
      - uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.12'
        with:
          name: coverage-skref
          path: skref/coverage.xml

  skyforge:
    needs: detect-changes
    if: needs.detect-changes.outputs.skyforge == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    defaults:
      run:
        working-directory: skyforge
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - run: pip install -e ".[dev]"
      - run: python -m pytest tests/ -v --tb=short --cov=skyforge --cov-report=xml:coverage.xml
        continue-on-error: true

  skskills:
    needs: detect-changes
    if: needs.detect-changes.outputs.skskills == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    defaults:
      run:
        working-directory: skskills
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - run: pip install -e ".[dev]"
      - run: python -m pytest tests/ -v --tb=short --cov=skskills --cov-report=xml:coverage.xml
      - uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.12'
        with:
          name: coverage-skskills
          path: skskills/coverage.xml

  sksovereign-agent:
    needs: detect-changes
    if: needs.detect-changes.outputs.sksovereign-agent == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    defaults:
      run:
        working-directory: sksovereign-agent
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - run: pip install -e ".[dev]"
      - run: python -m pytest tests/ -v --tb=short --cov=sksovereign_agent --cov-report=xml:coverage.xml
      - uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.12'
        with:
          name: coverage-sksovereign-agent
          path: sksovereign-agent/coverage.xml

  # ── Cross-package integration tests ──────────────────────────

  integration:
    needs: [capauth, skcomm, skchat, skmemory, skseal, sksecurity, skpdf, skcapstone, skref]
    if: always() && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install all packages
        run: |
          pip install -e capauth/[dev]
          pip install -e skmemory/[dev]
          pip install -e skcomm/[dev]
          pip install -e skchat/[cli,dev]
          pip install -e skseal/[dev]
          pip install -e sksecurity/[dev]
          pip install -e skpdf/[dev]
          pip install -e skref/[dev]
          pip install -e skcapstone/[dev]
      - name: Run integration tests
        working-directory: /tmp
        run: |
          python -m pytest $GITHUB_WORKSPACE/tests/integration/ \
            -v --tb=short --import-mode=importlib --rootdir=/tmp \
            --junit-xml=$GITHUB_WORKSPACE/integration-results.xml
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: integration-results.xml

  # ── Coverage aggregation ─────────────────────────────────────

  coverage:
    needs: [capauth, skcomm, skchat, skmemory, sksecurity, cloud9, skpdf, skcapstone, skseal, skref, skskills, sksovereign-agent]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          merge-multiple: true
          path: coverage-reports/
      - name: Coverage summary
        run: |
          echo "## Coverage Reports" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Package | Report |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|--------|" >> "$GITHUB_STEP_SUMMARY"
          for f in coverage-reports/*.xml; do
            if [ -f "$f" ]; then
              pkg=$(basename "$f" .xml | sed 's/coverage-//')
              echo "| $pkg | Uploaded |" >> "$GITHUB_STEP_SUMMARY"
            fi
          done

  # ── Gate job ─────────────────────────────────────────────────

  all-tests:
    needs:
      - capauth
      - skcomm
      - skchat
      - skmemory
      - sksecurity
      - cloud9
      - skpdf
      - skcapstone
      - skseal
      - skref
      - skyforge
      - skskills
      - sksovereign-agent
      - integration
      - coverage
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          declare -A results=(
            [capauth]="${{ needs.capauth.result }}"
            [skcomm]="${{ needs.skcomm.result }}"
            [skchat]="${{ needs.skchat.result }}"
            [skmemory]="${{ needs.skmemory.result }}"
            [sksecurity]="${{ needs.sksecurity.result }}"
            [cloud9]="${{ needs.cloud9.result }}"
            [skpdf]="${{ needs.skpdf.result }}"
            [skcapstone]="${{ needs.skcapstone.result }}"
            [skseal]="${{ needs.skseal.result }}"
            [skref]="${{ needs.skref.result }}"
            [skyforge]="${{ needs.skyforge.result }}"
            [skskills]="${{ needs.skskills.result }}"
            [sksovereign-agent]="${{ needs.sksovereign-agent.result }}"
            [integration]="${{ needs.integration.result }}"
          )

          failed=0
          passed=0
          skipped=0

          for pkg in "${!results[@]}"; do
            r="${results[$pkg]}"
            case "$r" in
              success) echo "  PASS  $pkg"; passed=$((passed + 1)) ;;
              failure) echo "  FAIL  $pkg"; failed=$((failed + 1)) ;;
              skipped) echo "  SKIP  $pkg"; skipped=$((skipped + 1)) ;;
              *)       echo "  ----  $pkg ($r)"; skipped=$((skipped + 1)) ;;
            esac
          done

          total=$((passed + failed + skipped))
          echo ""
          echo "Results: $passed/$total passed, $failed failed, $skipped skipped"

          if [ "$failed" -gt 0 ]; then
            echo "One or more packages failed"
            exit 1
          fi
          echo "All packages passed (or were skipped)"
