# Sovereign Agent Development Stack
#
# One command to spin up the full infrastructure for developing
# against the SKWorld ecosystem. Python packages run locally;
# this provides the backing services they connect to.
#
# Quick start:
#   docker compose up -d              # start everything
#   docker compose --profile sync up -d      # include Syncthing
#   docker compose --profile registry up -d  # include skills registry
#   docker compose --profile turn up -d      # include coturn TURN server
#   docker compose --profile full up -d      # everything
#   docker compose ps                 # check status
#   docker compose down               # stop all
#   docker compose down -v            # stop + delete data
#
# Or use the helper script:
#   bash scripts/dev-stack.sh up      # start everything
#   bash scripts/dev-stack.sh status  # health summary
#   bash scripts/dev-stack.sh down    # stop
#
# Connect from Python packages:
#   skmemory:   --qdrant-url http://localhost:6333
#   skmemory:   SKMEMORY_FALKORDB_URL=redis://localhost:6379
#   syncthing:  Web UI at http://localhost:8384
#   skills:     API at http://localhost:8082/api  (skills.smilintux.org/api in prod)
#
# Resource usage (idle):
#   Qdrant:          ~200MB RAM
#   FalkorDB:        ~100MB RAM
#   Syncthing:       ~50MB RAM
#   Skills Registry: ~80MB RAM
#   Total:           ~430MB RAM

services:
  # ─────────────────────────────────────────────────────────
  # Vector search — skmemory Level 2 backend
  # ─────────────────────────────────────────────────────────
  qdrant:
    image: qdrant/qdrant:latest
    container_name: skworld-qdrant
    ports:
      - "${QDRANT_REST_PORT:-6333}:6333"
      - "${QDRANT_GRPC_PORT:-6334}:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M

  # ─────────────────────────────────────────────────────────
  # Graph database — skmemory Level 3 backend
  # ─────────────────────────────────────────────────────────
  falkordb:
    image: falkordb/falkordb:latest
    container_name: skworld-falkordb
    ports:
      - "${FALKORDB_PORT:-6379}:6379"
    volumes:
      - falkordb_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M

  # ─────────────────────────────────────────────────────────
  # P2P sync mesh — vault sync, SKComm comms, seed propagation
  #
  # Activate with: docker compose --profile sync up -d
  # Web UI: http://localhost:8384
  # ─────────────────────────────────────────────────────────
  syncthing:
    image: syncthing/syncthing:latest
    container_name: skworld-syncthing
    hostname: skworld-dev
    profiles:
      - sync
      - full
    ports:
      - "${SYNCTHING_GUI_PORT:-8384}:8384"
      - "${SYNCTHING_LISTEN_PORT:-22000}:22000/tcp"
      - "${SYNCTHING_LISTEN_PORT:-22000}:22000/udp"
      - "21027:21027/udp"
    volumes:
      - syncthing_config:/var/syncthing/config
      - ${SKCAPSTONE_HOME:-${HOME}/.skcapstone}:/var/syncthing/skcapstone
    environment:
      STGUIADDRESS: "0.0.0.0:8384"
      PUID: "${PUID:-1000}"
      PGID: "${PGID:-1000}"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8384/rest/noauth/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 256M

  # ─────────────────────────────────────────────────────────
  # Skills Registry — skills.smilintux.org/api
  #
  # Activate with: docker compose --profile registry up -d
  # API docs: http://localhost:8082/api/docs
  # Skill listing: http://localhost:8082/api/skills
  #
  # Seed the 3 POC skills after first start:
  #   REGISTRY_URL=http://localhost:8082 \
  #   REGISTRY_ADMIN_TOKEN=<token> \
  #   python skills-registry/seed_examples.py
  # ─────────────────────────────────────────────────────────
  skills-registry:
    build:
      context: ./skills-registry
      dockerfile: Dockerfile
    container_name: skworld-skills-registry
    profiles:
      - registry
      - full
    ports:
      - "${SKILLS_REGISTRY_PORT:-8082}:8080"
    volumes:
      - skills_registry_data:/var/lib/skills-registry
    environment:
      REGISTRY_DB: /var/lib/skills-registry/registry.db
      REGISTRY_PACKAGES_DIR: /var/lib/skills-registry/packages
      REGISTRY_ADMIN_TOKEN: "${REGISTRY_ADMIN_TOKEN:-}"
      REGISTRY_OPEN_PUBLISH: "${REGISTRY_OPEN_PUBLISH:-false}"
      PORT: "8080"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 128M

  # ─────────────────────────────────────────────────────────
  # TURN/STUN server — WebRTC relay for skcomm webrtc transport
  #
  # Activate with: docker compose --profile turn up -d
  # Also included in: docker compose --profile full up -d
  #
  # Required env vars:
  #   COTURN_EXTERNAL_IP   — public IP of this host
  #   COTURN_AUTH_SECRET   — openssl rand -hex 32  (same value as SKCOMM_TURN_SECRET)
  # Optional:
  #   COTURN_TLS_CERT, COTURN_TLS_PKEY — cert paths inside container
  #   COTURN_CERTS_DIR     — host cert directory to mount (default: /etc/letsencrypt/live/turn.skworld.io)
  # ─────────────────────────────────────────────────────────
  coturn:
    build:
      context: ./skstacks/coturn
      dockerfile: Dockerfile
    image: skworld-coturn:latest
    container_name: skworld-coturn
    profiles:
      - turn
      - full
    environment:
      COTURN_EXTERNAL_IP: "${COTURN_EXTERNAL_IP:?set COTURN_EXTERNAL_IP to your public IP}"
      COTURN_AUTH_SECRET: "${COTURN_AUTH_SECRET:?set COTURN_AUTH_SECRET (same as SKCOMM_TURN_SECRET)}"
      COTURN_TLS_CERT: "${COTURN_TLS_CERT:-/etc/coturn/certs/fullchain.pem}"
      COTURN_TLS_PKEY: "${COTURN_TLS_PKEY:-/etc/coturn/certs/privkey.pem}"
    ports:
      - "${COTURN_PORT:-3478}:3478/udp"
      - "${COTURN_PORT:-3478}:3478/tcp"
      - "${COTURN_TLS_PORT:-5349}:5349/tcp"
      - "${COTURN_TLS_PORT:-5349}:5349/udp"
      - "49152-65535:49152-65535/udp"
    volumes:
      - "${COTURN_CERTS_DIR:-/etc/letsencrypt/live/turn.skworld.io}:/etc/coturn/certs:ro"
      - coturn_logs:/var/log/coturn
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "turnutils_stunclient 127.0.0.1 2>/dev/null || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          memory: 256M

volumes:
  qdrant_data:
    driver: local
  falkordb_data:
    driver: local
  syncthing_config:
    driver: local
  skills_registry_data:
    driver: local
  coturn_logs:
    driver: local
